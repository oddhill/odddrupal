<?php
/**
 * @file
 * A update module that brings sedermera intranÃ¤t up to date
 */

/**
 * Runs all update functions on install.
 */
function sedermera_update_install() {
  sedermera_update_update_7001();
  sedermera_update_update_7002();
  sedermera_update_update_7003();
}

/**
 * Menu items, removes no longer used.
 * @return string message of success.
 */
function sedermera_update_update_7001() {
  $result = db_query("SELECT mlid FROM {menu_links} WHERE menu_name = :menu_name", array(':menu_name' => 'main-menu'));
  $done = FALSE;

  foreach ($result as $record) {
    if ($link = menu_link_load($record->mlid)) {
      if (strcmp($link['link_title'], 'Administrera dokument') == 0 && strcmp($link['link_path'], 'dokument/admin') == 0) {
        if (!$done) {
          menu_link_delete($record->mlid);
          $done = TRUE;
        }
      }
      elseif (strcmp($link['link_title'], 'Dokument logg') == 0 && strcmp($link['link_path'], 'dokument/log') == 0) {
        menu_link_delete($record->mlid);
      }
    }
  }

  return t('Menu links removed successfully');
}

/**
 * User roles, removes no longer used.
 * @return string message of success.
 */
function sedermera_update_update_7002() {
  user_role_delete('Dokument moderator');
  user_role_delete('Dokument skapare');

  return t('User roles removed successfully');
}

/**
 * Menu items, removes no longer used.
 * @return string message of success.
 */
function sedermera_update_update_7003() {
  $result = db_query("SELECT mlid FROM {menu_links} WHERE menu_name = :menu_name", array(':menu_name' => 'main-menu'));
  $done = FALSE;

  foreach ($result as $record) {
    if ($link = menu_link_load($record->mlid)) {
      if ($link['hidden']) {
        menu_link_delete($record->mlid);
      }
    }
  }

  return t('Menu links removed successfully');
}

/**
 * Delete unused fields
 * @return null
 */
function sedermera_update_update_7004() {
  field_delete_field('field_control_approved');
  field_delete_field('field_control_date');
  field_delete_field('field_control_files');
  field_delete_field('field_shared_ctrl_comp');
  field_delete_field('field_shared_ctrl_credit');
  field_delete_field('field_shared_ctrl_eu');
  field_delete_field('field_shared_ctrl_ext');
  field_delete_field('field_shared_ctrl_id');
  field_delete_field('field_shared_ctrl_id_real');
  field_delete_field('field_shared_ctrl_ovr');
  field_delete_field('field_shared_ctrl_ptv');
  field_delete_field('field_shared_ctrl_reg');
  field_delete_field('field_shared_ctrl_upp');

  field_purge_batch(100);
}
