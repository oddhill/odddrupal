<?php

/**
 * @file sedermera_investor.module
 * Main module file for the Sedermera Investor module.
 */

/**
 * Implements hook_permission().
 */
function sedermera_investor_permission() {
  return array(
    'administer investors' => array(
      'title' => t('Administer investors'),
      'description' => t('Administer any investor bundle and access the administration list.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function sedermera_investor_menu() {
  $items['investerare/skapa'] = array(
    'title' => 'L채gg till investerare',
    'page callback' => 'sedermera_investor_create_page',
    'access arguments' => array('administer investors'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function sedermera_investor_menu_alter(&$items) {
  // Get the entity info for the investor entity type.
  $investor_info = entity_get_info('investor');

  // Iterate through the bundles.
  foreach ($investor_info['bundles'] as $bundle_name => $bundle_info) {
    // Change the delete link for every bundle to a regular menu callback in
    // order to get rid of the tab.
    $items["investor/{$bundle_name}/%eckentity/delete"]['type'] = MENU_CALLBACK;

    // Change the title callback for every bundle in order to use the entity
    // label.
    $items["investor/{$bundle_name}/%eckentity"]['title callback'] = 'sedermera_investor_entity_page_title';
    $items["investor/{$bundle_name}/%eckentity"]['title arguments'] = array(2);
  }
}

/**
 * Title callback for the entity pages for investor bundles.
 */
function sedermera_investor_entity_page_title($entity) {
  // Return the label of the entity.
  return entity_label('investor', $entity);
}

/**
 * Implements hook_admin_paths_alter().
 */
function sedermera_investor_admin_paths_alter(&$paths) {
  // Don't treat the add forms for investor bundles as administrative pages, in
  // order to use the sites default theme rather than the administration theme.
  $paths['admin/structure/entity-type/investor/*/add'] = FALSE;
}

/**
 * Page callback for the investerare/skapa path.
 *
 * This will generate a page that looks like the node/add page.
 *
 * @see node_add_page()
 */
function sedermera_investor_create_page() {
  // Get the entity info for the investor entity type.
  $investor_info = entity_get_info('investor');

  // Setup the descriptions for the different bundles. The ECK module doesn't
  // support descriptions, like node types. This is a way to mimic the same
  // behavior for this particular page.
  $descriptions = array(
    'company' => 'L채gg till ett nytt investmentbolag. Dessa kan kopplas till flera 채gare.',
    'person' => 'L채gg till en ny privatperson.',
  );

  // Iterate through the bundles, add add a link for each bundle. This will be
  // used to genereate the output.
  foreach ($investor_info['bundles'] as $bundle_name => $bundle_info) {
    if (user_access("eck administer investor $bundle_name entities") || user_access("eck add investor $bundle_name entities"))
    $items[] = array(
      'title' => $bundle_info['label'],
      'href' => "admin/structure/entity-type/investor/{$bundle_name}/add",
      'description' => isset($descriptions[$bundle_name]) ? $descriptions[$bundle_name] : '',
      'localized_options' => array(
        'query' => array('destination' => 'investerare'),
      ),
    );
  }

  // Return a list which looks like the node add list. This isn't actually
  // nodes, but it's convinient to use the same theme function since we'd like
  // to generate a similar list.
  return theme('node_add_list', array('content' => $items));
}

/**
 * Implements hook_field_widget_form_alter().
 */
function sedermera_investor_field_widget_form_alter(&$element, &$form_state, $context) {
  // Disable access to the field_shared_temp field. This will hopefully be
  // managed automatically in the future. We'll disable it for now, just to make
  // sure that we avoid any confusion for the end user.
  if ($element['#field_name'] == 'field_shared_temp') {
    $element['#access'] = FALSE;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function sedermera_investor_form_eck__entity__form_add_investor_person_alter(&$form, &$form_state, $form_id) {
  // Set the active menu trail.
  menu_tree_set_path('main-menu', 'investerare/skapa');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function sedermera_investor_form_eck__entity__form_add_investor_company_alter(&$form, &$form_state, $form_id) {
  // Set the active menu trail.
  menu_tree_set_path('main-menu', 'investerare/skapa');
}

/**
 * Implements hook_entity_view().
 */
function sedermera_investor_entity_view($entity, $type, $view_mode, $langcode) {
  // Bail out if this isn't an investor entity that's viewed on its own page.
  if ($type != 'investor' || $view_mode != 'full') {
    return;
  }

  // Set the active menu trail.
  menu_tree_set_path('main-menu', 'investerare');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function sedermera_investor_form_eck__entity__form_edit_investor_person_alter(&$form, &$form_state, $form_id) {
  // Set the active menu trail.
  menu_tree_set_path('main-menu', 'investerare');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function sedermera_investor_form_eck__entity__form_edit_investor_company_alter(&$form, &$form_state, $form_id) {
  // Set the active menu trail.
  menu_tree_set_path('main-menu', 'investerare');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function sedermera_investor_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  // Alter the exposed form for the investor page and offer embed displays.
  if (in_array($form['#id'], array('views-exposed-form-investors-page', 'views-exposed-form-investors-offer-embed'))) {
    // Get the country values from the database. We'll use a regular DB Query in
    // order to improve performance.
    $available_countries = db_query("SELECT DISTINCT field_shared_address_country FROM {field_data_field_shared_address}")->fetchAllKeyed();

    // Remove the options that aren't stored in the database.
    $form['country']['#options'] = array_intersect_key($form['country']['#options'], $available_countries);

    // Disable access to the country field and remove the label if the options
    // are empty.
    if (empty($form['country']['#options'])) {
      $form['country']['#access'] = FALSE;
      unset($form['#info']['filter-field_shared_address_country']);
    }

    // Get the industry values from the database. We'll use a regular DB Query
    // here as well, for the same reason as above...
    $available_industries = db_query("SELECT DISTINCT field_shared_industries_tid FROM {field_data_field_shared_industries}")->fetchAllKeyed();

    // Remove the options that aren't stored in the database, and disable access
    // to the field if the options are empty.
    $form['industries']['#options'] = array_intersect_key($form['industries']['#options'], $available_industries);

    // Disable access to the industries field and remove the label if the
    // options are empty.
    if (empty($form['industries']['#options'])) {
      $form['industries']['#access'] = FALSE;
      unset($form['#info']['filter-field_shared_industries_tid']);
    }
  }
}
